<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ö–∞—Ä—Ç–∞ –∑–∞–¥–∞—á Helpdesk</title>

<style>
  body { margin: 0; padding: 0; }
  #map { width: 100%; height: 100vh; }

  .balloon-btn {
      display: inline-block;
      padding: 8px 12px;
      margin: 4px 4px 0 0;
      border-radius: 6px;
      font-weight: bold;
      text-decoration: none;
      font-size: 14px;
  }

  .btn-yandex {
      background: #ffcc00;
      color: #000;
  }

  .btn-intra {
      background: #2c7be5;
      color: #fff;
  }
</style>

<!-- –Ø–Ω–¥–µ–∫—Å API -->
<script src="https://api-maps.yandex.ru/2.1/?apikey=dc60a9c5-3268-40d8-9bf7-faa1168a1b70&lang=ru_RU" type="text/javascript"></script>

</head>
<body>

<div id="map"></div>

<script>
ymaps.ready(init);

async function init() {

    const map = new ymaps.Map("map", {
        center: [55.76, 37.64],
        zoom: 10
    });

    const tasks = await fetch("tasks.json").then(r => r.json());

    for (let t of tasks) {
        if (!t.address) continue;

        ymaps.geocode(t.address).then(function (res) {

            const firstGeoObject = res.geoObjects.get(0);
            if (!firstGeoObject) return;

            const coords = firstGeoObject.geometry.getCoordinates();

            const addressEncoded = encodeURIComponent(t.address);
            const yandexLink = `https://yandex.ru/maps/?text=${addressEncoded}`;
            const intraLink = `https://helpdesk.f2c.ru/Task/View/${t.id}`;

            const balloonContent = `
                <div style="font-size:14px;">
                    <b>–ó–∞—è–≤–∫–∞ #${t.id}</b><br>
                    –°—Ç–∞—Ç—É—Å: ${t.status}<br>
                    ${t.address}<br><br>

                    <a href="${yandexLink}" target="_blank" class="balloon-btn btn-yandex">
                        üìç –û—Ç–∫—Ä—ã—Ç—å –≤ –Ø–Ω–¥–µ–∫—Å
                    </a>

                    <a href="${intraLink}" target="_blank" class="balloon-btn btn-intra">
                        üõ† –û—Ç–∫—Ä—ã—Ç—å –≤ –ò–Ω—Ç—Ä–µ
                    </a>
                </div>
            `;

            const placemark = new ymaps.Placemark(coords, {
                balloonContent: balloonContent
            }, {
                preset: "islands#redDotIcon"
            });

            map.geoObjects.add(placemark);
        });
    }
}
</script>

</body>
</html>
