<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ö–∞—Ä—Ç–∞ –∑–∞–¥–∞—á Helpdesk</title>

<style>
  body { margin: 0; padding: 0; }
  #map { width: 100%; height: 100vh; }

  .balloon-task {
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #ddd;
  }

  .balloon-btn {
      display: inline-block;
      padding: 6px 10px;
      margin: 4px 4px 0 0;
      border-radius: 6px;
      font-weight: bold;
      text-decoration: none;
      font-size: 13px;
  }

  .btn-yandex {
      background: #ffcc00;
      color: #000;
  }

  .btn-intra {
      background: #2c7be5;
      color: #fff;
  }
</style>

<script src="https://api-maps.yandex.ru/2.1/?apikey=dc60a9c5-3268-40d8-9bf7-faa1168a1b70&lang=ru_RU" type="text/javascript"></script>

</head>
<body>

<div id="map"></div>

<script>
ymaps.ready(init);

async function init() {

    const map = new ymaps.Map("map", {
        center: [55.76, 37.64],
        zoom: 10
    });

    const tasks = await fetch("tasks.json").then(r => r.json());

    const grouped = {}; // —Å—é–¥–∞ –±—É–¥–µ–º —Å–∫–ª–∞–¥—ã–≤–∞—Ç—å –∑–∞—è–≤–∫–∏ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º

    // --- –ì–ï–û–ö–û–î–ò–†–£–ï–ú –ò –ì–†–£–ü–ü–ò–†–£–ï–ú ---
    for (let t of tasks) {

        if (!t.address) continue;

        try {
            const geo = await ymaps.geocode(t.address);
            const obj = geo.geoObjects.get(0);
            if (!obj) continue;

            const coords = obj.geometry.getCoordinates();

            // –∫–ª—é—á ‚Äî –æ–∫—Ä—É–≥–ª—ë–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
            const key = coords[0].toFixed(6) + "," + coords[1].toFixed(6);

            if (!grouped[key]) {
                grouped[key] = {
                    coords: coords,
                    address: t.address,
                    tasks: []
                };
            }

            grouped[key].tasks.push(t);

        } catch (e) {
            console.log("–û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è:", t.address);
        }
    }

    // --- –°–û–ó–î–ê–Å–ú –ú–ï–¢–ö–ò ---
    for (let key in grouped) {

        const group = grouped[key];

        let balloonContent = `<div style="font-size:14px;"><b>${group.address}</b><br><br>`;

        for (let t of group.tasks) {

            const addressEncoded = encodeURIComponent(t.address);
            const yandexLink = `https://yandex.ru/maps/?text=${addressEncoded}`;
            const intraLink = `https://helpdesk.f2c.ru/Task/View/${t.id}`;

            balloonContent += `
                <div class="balloon-task">
                    <b>–ó–∞—è–≤–∫–∞ #${t.id}</b><br>
                    –°—Ç–∞—Ç—É—Å: ${t.status}<br>

                    <a href="${yandexLink}" target="_blank" class="balloon-btn btn-yandex">
                        üìç –Ø–Ω–¥–µ–∫—Å
                    </a>

                    <a href="${intraLink}" target="_blank" class="balloon-btn btn-intra">
                        üõ† –ò–Ω—Ç—Ä–∞
                    </a>
                </div>
            `;
        }

        balloonContent += `</div>`;

        const placemark = new ymaps.Placemark(group.coords, {
            balloonContent: balloonContent
        }, {
            preset: "islands#redDotIcon"
        });

        map.geoObjects.add(placemark);
    }
}
</script>

</body>
</html>
